<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>主机命令执行页</title>
        <!-- Bootstrap 进度条 -->
        <link href="bootstrap/components/css/bootstrap-progressBar.min.css" rel="stylesheet" />
        <!-- 控制进度条等样式 -->
        <link href="css/style.css"   rel="stylesheet"/>
        <link rel="stylesheet" type="text/css" href="jqmobile/jquery.mobile-1.4.5.css">
        <link rel="stylesheet" type="text/css" href="css/jqm-themes/b/jqm-ui-theme.css">
        <link rel="stylesheet" type="text/css" href="css/jqm-themes/d/jqm-ui-theme-d-alert.css">
        <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
        <script src="jquery/jquery-1.11.1.js"></script>
        <script type="text/javascript" src="jqmobile/jquery.mobile-1.4.5.js"></script>
        <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
        <script src="js/html5css3comp/html5shiv.min.js"></script>
        <script src="js/html5css3comp/respond/1.4.2/respond.min.js"></script>
        <![endif]-->
    </head>
    <body>
        <div data-role="page"  id="home" class="withPagingWidget">
            
            <div data-role="header">
                <img style="display:block;margin:0 auto;" src="image\logo.gif">
                <h1>
                
                
                轻量化的业务系统运行环境信息采集和处理工具
                
                </h1>
            </div>
            
            <div data-role="content">
                
                
                
                
                <label class="control-label"  for="command">请在下框输入要批量执行的命令</label>
                
                <input data-theme="b" type="text" class="form-control" placeholder="请输入要执行的命令" id="command">
                
                
                <div class="ui-grid-a">
                    <div class="ui-block-a" >
                        <a  data-role="button" id="collect" href="" data-theme="b" data-icon="gear">执行
                        </a>
                        <div data-role="popup" id="invalidCommandAlert" data-overlay-theme="b" style="max-width:400px;">
                            <div data-role="header" data-theme="d"><h1>警告</h1></div>
                            <div data-role="content" data-theme="d"><p>输入的命令不合法，请重新输入</p></div>
                           
                        </div>
                    </div>
                    <div class="ui-block-b">
                        <button id="export" data-theme="b" type="button"  data-icon="arrow-d">导出</button>
                    </div>
                </div>
                
                <div class="progress">
                    <div id="progressBar" class="progress-bar" style="color:black;white-space:nowrap;width:0%;">命令执行进度</div>
                </div>
                <table data-role="table" id="batResultTable" data-mode="columntoggle" data-column-btn-text="选择列..." class="ui-responsive table-stroke">
                    <thead>
                        <tr class="table-head">
                            <th>序&nbsp;号</th>
                            <th>业务系统</th>
                            <th data-priority="3">主机名</th>
                            <th data-priority="4">服务器类型</th>
                            <th data-priority="5">IP地址</th>
                            <th data-priority="6">操作系统</th>
                            <th data-priority="6">返回结果</th>
                            
                        </tr>
                    </thead>
                    <tbody>
                        
                        
                    </tbody>
                </table>
                
                
                
                </div><!-- 内容区 结束 -->
                 <div  data-role="footer" data-position="fixed" >
          <h5 id="pageSign">
          0/0
          </h5>
          <div data-role="navbar" data-iconpos="top">
            <ul>
              <li id="previous">
                <a href="#"  data-transition="fade"  data-icon="arrow-l" data-theme="b">
                  上一页
                </a>
              </li>
              <li id="next">
                <a href="#page1" data-transition="fade"  data-icon="arrow-r" data-theme="b">
                  下一页
                </a>
              </li>
            </ul>
          </div>
          <div data-role="popup" id="toFirstTip">
                                <p>已经是第一页了</p>
                            </div>
        </div>
         
            </div>
            <!-- 输入命令的对话框页面 -->
            <div data-role="page" id="retypeCommandDialog" data-dialog="true">
                <div data-role="header"   data-theme="b"><h1>命令输入行</h1></div>
                <div data-role="content">
                    <input type="text" id="finalCommandText" placeholder="请小心输入命令"/>
                </div>
                <div data-role="footer"   data-theme="b">
                    <div data-role="navbar">
                        <ul>
                            <li><a href="#home">取消</a></li>
                            <li id="finalCommandBut"><a href="">确定</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <iframe src="" style="display:none;" id="exportIframe"></iframe>
            <!-- DWR -->
            <script type="text/javascript" src="dwr/util.js"></script>
            <script type="text/javascript" src="dwr/engine.js"></script>
            <script type="text/javascript" src="dwr/interface/CommandExecutor.js"></script>
            <script src="js/json/json_parse.js"></script>
            <script src="js/collecttool.js"></script>
            <script src="js/alphadiv.js" type="text/javascript"></script>
            <script type="text/javascript">
            //实时显示采集进度
            function show(msg) {
                console.log(msg);
                msg = JSON.parse(msg);
                var progressBar = $("#progressBar");
                var progressBarLabel = progressBar;
                progressBarLabel.text(msg.msg + msg.nowNum + "/" + msg.maxNum + "       " + msg.ip);
                msg.maxNum == 0 ? progressBar.css('width', '100%') : progressBar.css('width', msg.nowNum / msg.maxNum * 100 + '%')
            }
            $(document).ready(function() {
                $('#previous').click(function() {
                    $('#toFirstTip').popup('open');
                });
                $('#command').click(function() {
                    $(":mobile-pagecontainer").pagecontainer("change", "#retypeCommandDialog");
                });
                $('#finalCommandBut').click(function() {
                    $('#command').val($('#finalCommandText').val());
                    $(":mobile-pagecontainer").pagecontainer("change", "#home");
                });
                //表示允许使用推送技术
                dwr.engine.setActiveReverseAjax(true);
                dwr.engine.setNotifyServerOnPageUnload(true);

                $('#collect').click(function() {
                    var that = this;
                    //将上一次采集到的主机表格清空
                    var $tBody = $('table tbody');
                    $tBody.html('');
                    var command = $('#command').val();
                    //检查输入命令的合法性
                    if (!CollectTool.validate(command)) {
                        $('#invalidCommandAlert').popup('open');
                        return;
                    }
                    //单击执行按钮进入采集过程，这个过程中所有按钮不能操作
                    CollectTool.disableButtons(['#collect', '#export']);
                    var url = '/ssh/collect/bat?command=' + command;

                    CommandExecutor.batCommand(command, {
                        callback: function(data) {
                            data = JSON.parse(data);
                            if (data.length > 0) { //采集之后并且有服务器被采集
                                /**
                                * 主机无法采集的情况下，detail为null
                                各要显示的主机详情项单元格显示"未知"
                                */
                                function hostDot(pName, host) {
                                    return host[pName] ? host[pName] : "未知";
                                }
                                //显示采集到的服务器列表
                                for (var i = 0; i < data.length; i++) {
                                    var tr = $('<tr></tr>');
                                    var host = data[i];
                                    tr.appendTo($tBody);
                                    $('<td></td>').text(i + 1).appendTo(tr); //序号
                                    $('<td></td>').text(hostDot('buss', host)).appendTo(tr); //业务名称
                                    $('<td></td>').text(hostDot('hostName', host)).appendTo(tr); //主机名
                                    $('<td></td>').text(hostDot('hostType', host)).appendTo(tr); //类型（数据库服务器or应用服务器）
                                    $('<td></td>').text(hostDot('ip', host)).appendTo(tr); //IP
                                    $('<td></td>').text(hostDot('os', host)).appendTo(tr); //操作系统
                                    $('<td style="white-space:pre;"></td>').text(data[i].commandResult).appendTo(tr); //命令执行的返回结果
                                }
                                $tBody.parent().table('rebuild');

                            } else { //没有服务器被采集  不导出文件  后续可添加提示或其他操作
                            }
                            //采集完毕，恢复按钮
                            CollectTool.enableButtons(['#export', '#collect']);
                        },
                        errorHandler:function(){
                            alert('与服务器断开连接');
                        }
                    });

                });

            });
        </script>
    </body>
</html>